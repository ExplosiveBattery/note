“暗云”木马： 藏匿在磁盘引导区，通过下载来获取病毒代码，推广
	Ring 3与Ring 0的通信方式：微软正统的通信方式是Ring 0代码创建驱动设备，Ring 3代码通过打开Ring 0创建的设备开实现相互之间的通信。常见的木马使用的通信方式则是在Ring0对指定的API函数进行Hook，而暗云木马是通过注册回调（设置注册表回调）的方式来实现。Hook磁盘驱动实现对已感染的MBR进行隐藏和保护。电脑开机后，受感染的磁盘MBR第一时间获得CPU的控制权，其功能是将磁盘3-63扇区的木马主体加载到内存中解密执行，木马主体获得执行后通过挂钩int 15中断来获取第二次执行的机会，随后读取第二扇区中的备份MBR正常地引导系统启动。系统引导启动时会通过int 15中断查询内存信息，此时挂钩15号中断的木马便得以第二次获得CPU控制权，获得控制权后木马便挂钩BILoadImageEx函数，调用原始15号中断并将控制权交回给系统继续引导。当系统引导代码调用BILoadImageEx加载ntoskrnl.exe时，木马便第三次获得控制权，获得控制权后木马再一次执行挂钩操作，此次挂钩的位置是ntoskrnl.exe的入口点，随后将控制权交给系统继续引导。当引导完毕进入windows内核时，挂钩ntoskrnl入口点的木马代码第四次获得CPU控制权，此时木马已真正进入windows内核中，获得控制权后，分配一块内存空间，将木马内核的主功能代码拷贝到分配的空间中，并通过创建PsSetCreateThreadNotifyRoutine回调的方式使主功能代码得以执行，成功插入到ring3的一个svhost进程。至此完成木马由MBR到windows内核的加载过程。
	木马从云端下载了攻击代码，全都是加密后的模块dat，不过是最简单的循环位移来进行加密。在模块的前四个字节设置“CODE”来畸形数据合法性校验。还有个模块是使用了负载的加密算法来进行加密，其中文件的前0x32字节位解密key，解密以后是针对x86和x64的两种windows版本的模块（内核Shellcode、应用层Shellcode以及作者自己的jmdm.db）。
	木马能够在内核中直接结束部分安全软件进程，同时可以向任意安全软件进程插入APC执行。插入的APC代码会关闭安全软件的文件监控设备句柄，会导致安全软件文件监控失效，大大减少了被检测的机率。同时“暗云”一份BootKit同时兼容x86、x64两种版本的操作系统，且能够兼容xp、win7等当前主流的操作系统版本，因此影响范围十分广泛。第二个模块首先被NtSetInformationKey传入内核，由内核模块从内核Shellcode开始执行，内核Shellcode的功能有如下两个：1）结束指定杀软进程，包括kxetray.exe、kxescore.exe、QQPcTray.exe，由于百度的电脑管家的进程有object钩子防护，因此不会被干掉。2）遍历进程，如果进程名为以下之一，则将尾部的应用层Shellcode 以apc的方式插入到该进程中，插入一个进程后便退出遍历，不再插其他进程。具体进程列表如下：360tray.exe、360safe.exe、360sd.exe、360rp.exe、zhudongfangyu.exe、QQPcRtp.exe、KSafeSvc.exe、KSafeTray.exe、BaiduSdTray.exe、BaiduAnTray.exe、BadduAnSvc.exe、BaiduHips.exe、BaiduProtect.exe、wscntfy.exe、spoolsv.exe、alg.exe，以上进程名均硬编码于Shellcode中。3)关闭指定杀软句柄\\Device\\360SelfProtection、\\Device\\36-SpShadow0、\\Device\\qutmipc、\\FileSystem\\Filters\\FltMgrMsg、\\FilSystem\\Filters\\qutmdrv。
	Inst.exe运行后首先在桌面上释放一个名为“美女视频聊天”的快捷方式，该快捷方式指向一个http://haomm.com，并带了一个推广id，实现推广网站盈利。Inst.exe还会释放XnfBase.dll、thpro32.dll两个dll到%appdata%目录下，并通过注册服务的方式加载这两个dll。XnfBase.dll实现的功能是LSP劫持，当用户使用浏览器浏览www.hao123.com、www.baidu.com等网站的时候在其网址尾部添加推广ID，从而实现获利。thpro32.dll实现的功能是：不断地删除LSP模块，防止其他木马或安全软件通过LSP再次修改推广ID。
	Update.exe运行后会创建两个svchost.exe傀儡进程，并将解密出的功能模块分别注入到两个进程中，一个负责向安卓手机安装推广app、另一个现向含有“私服”等关键词的QQ群上传共享文件，用来推广私服游戏获利。


	把我们的驱动设置为boot类型。boot类型的驱动是启动最早的驱动程序，在系统引导时就必须加载完毕。这样我们的驱动先取得控制权，随后HOOK一些关键函数(比如驱动加载、进程结束等函数)。